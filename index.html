<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Ambiental Volvo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .brand-blue { color: #0066CC; }
        .brand-blue-bg { background-color: #0066CC; }
        .brand-blue-bg:hover { background-color: #0052a3; }
        .volvo-gradient {
            background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            transition: all 0.2s ease-in-out;
            transform: translateY(0);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .answer-option {
            border: 2px solid #e5e7eb;
        }
        .answer-option.selected {
            border-color: #0066CC;
            background-color: #e0f2fe;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="volvo-gradient min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-md mx-auto">

        <!-- Seção de Login -->
        <div id="login-section" class="card p-8 text-center fade-in">
            <img src="https://placehold.co/150x40/0066CC/FFFFFF?text=VOLVO" alt="Logo da Volvo" class="mx-auto mb-6 h-10">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Quiz Ambiental</h1>
            <p class="text-gray-600 mb-6">Insira seu e-mail corporativo para participar.</p>
            <div id="error-message" class="text-red-500 mb-4 text-sm font-medium hidden"></div>
            <input type="email" id="email-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="seu.nome@volvo.com">
            <button id="start-quiz-btn" class="w-full brand-blue-bg text-white font-bold py-3 px-4 rounded-lg btn opacity-50 cursor-not-allowed" disabled>
                <span id="start-btn-text" class="hidden">Começar o Quiz</span>
                <span id="start-btn-loader">
                    <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
        </div>

        <!-- Seção do Quiz -->
        <div id="quiz-section" class="card p-6 md:p-8 hidden fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold brand-blue">Questão <span id="question-number"></span>/<span id="total-questions"></span></h2>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="brand-blue-bg h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="question-text" class="text-lg text-gray-800 font-medium mb-6"></p>
            <div id="answer-options" class="space-y-3">
                <!-- Opções de resposta serão inseridas aqui -->
            </div>
             <button id="next-question-btn" class="w-full mt-8 brand-blue-bg text-white font-bold py-3 px-4 rounded-lg btn opacity-50" disabled>Próxima</button>
        </div>

        <!-- Seção de Resultados -->
        <div id="results-section" class="card p-8 text-center hidden fade-in">
            <h2 class="text-3xl font-black text-gray-800 mb-2">Quiz Finalizado!</h2>
            <p class="text-gray-600 mb-6">Obrigado por sua participação.</p>
            
            <div id="final-result-text" class="bg-gray-100 rounded-xl p-6 my-8 text-2xl font-bold text-gray-800">
                <!-- O resultado será inserido aqui pelo JavaScript -->
            </div>
            
            <p class="text-gray-500">O sorteio do prêmio será realizado ao final do evento.</p>
        </div>
        
        <!-- Seção do Admin -->
        <div id="admin-section" class="hidden fade-in">
             <div class="card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Lista de Participantes</h2>
                <div id="submissions-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                    <!-- Lista de participantes será inserida aqui -->
                </div>
                <button id="back-to-login-btn" class="w-full mt-8 border-2 border-gray-400 text-gray-600 font-bold py-3 px-4 rounded-lg btn">Voltar</button>
             </div>
        </div>

    </div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuração do Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD7REdPQbT8cgKRMvYX_BMFXPUCmk1piR4",
            authDomain: "volvo-387c7.firebaseapp.com",
            projectId: "volvo-387c7",
            storageBucket: "volvo-387c7.appspot.com",
            messagingSenderId: "414825587940",
            appId: "1:414825587940:web:f39053a9303022cf7ff8f1",
            measurementId: "G-M4FPY5XWLL"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'volvo-quiz-app';

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const submissionsCollectionRef = collection(db, `artifacts/${appId}/public/data/quizSubmissions`);

        // Definição das novas perguntas do Quiz
        const quizQuestions = [
            { question: "Qual é a meta global do Grupo Volvo para atingir o Net Zero (neutralidade de carbono)?", options: ["2025", "2030", "2040", "2050"], answer: "2040" },
            { question: "A estratégia de sustentabilidade da Volvo está baseada em três pilares. Quais são eles?", options: ["Tecnologia, Inovação e Crescimento", "Clima, Recursos e Pessoas", "Produção, Qualidade e Lucro", "Meio Ambiente, Segurança e Transporte"], answer: "Clima, Recursos e Pessoas" },
            { question: "O que significa o pilar “Recursos” na estratégia da Volvo?", options: ["Comprar mais recursos", "Usar água e materiais de forma eficiente e circular", "Reduzir tempo na produção", "Fazer mais reuniões sobre meio ambiente"], answer: "Usar água e materiais de forma eficiente e circular" },
            { question: "Quando você apaga as luzes e desliga os monitores ao sair, está contribuindo com qual pilar?", options: ["Pessoas", "Prosperidade", "Clima", "Segurança"], answer: "Clima" },
            { question: "Por que realizamos ações de 5S e coleta seletiva na Volvo do Brasil?", options: ["Para liberar espaço físico", "Para reduzir desperdícios e aumentar a reciclagem, alinhando-se ao pilar Recursos", "Para facilitar auditorias", "Para ganhar certificações ambientais"], answer: "Para reduzir desperdícios e aumentar a reciclagem, alinhando-se ao pilar Recursos" },
            { question: "Qual ação faz parte da meta da Volvo de reduzir as emissões nas fábricas?", options: ["Reduzir o número de veículos produzidos", "Utilizar energia elétrica de fontes renováveis", "Comprar menos materiais", "Limitar o uso de internet nas plantas"], answer: "Utilizar energia elétrica de fontes renováveis" },
            { question: "Cuidar da saúde física e mental dos colaboradores faz parte de qual pilar?", options: ["Clima", "Recursos", "Pessoas", "Inovação"], answer: "Pessoas" },
            { question: "Qual dos exemplos abaixo representa um pensamento de economia circular dentro da Volvo?", options: ["Comprar sempre novos materiais e equipamentos mais modernos", "Utilizar materiais descartáveis apenas quando houver estoque suficiente", "Remanufaturar componentes, dar segunda vida a peças e reutilizar embalagens retornáveis na cadeia logística", "Eliminar processos antigos da produção para agilizar a operação"], answer: "Remanufaturar componentes, dar segunda vida a peças e reutilizar embalagens retornáveis na cadeia logística" },
            { question: "No contexto de sustentabilidade, por que a eficiência no uso de recursos como energia e água é tão importante mesmo em áreas administrativas?", options: ["Porque é uma exigência da ISO 14001", "Porque pequenas ações somadas no dia a dia geram impacto ambiental e financeiro relevante", "Porque ajuda a reduzir o tempo de expediente", "Porque é uma forma de valorizar o marketing verde"], answer: "Porque pequenas ações somadas no dia a dia geram impacto ambiental e financeiro relevante" },
            { question: "Por que a Volvo prioriza um ambiente de trabalho seguro e inclusivo?", options: ["Para cumprir normas internacionais", "Porque faz parte do pilar Pessoas, cuidando do bem-estar e desenvolvimento dos colaboradores", "Para melhorar os indicadores financeiros", "Para reduzir custos com saúde"], answer: "Porque faz parte do pilar Pessoas, cuidando do bem-estar e desenvolvimento dos colaboradores" }
        ];

        // Variáveis de estado do Quiz
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let userEmail = '';
        let selectedOption = null;

        // Elementos da UI
        const loginSection = document.getElementById('login-section');
        const quizSection = document.getElementById('quiz-section');
        const resultsSection = document.getElementById('results-section');
        const adminSection = document.getElementById('admin-section');
        
        const emailInput = document.getElementById('email-input');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const startBtnText = document.getElementById('start-btn-text');
        const startBtnLoader = document.getElementById('start-btn-loader');
        const errorMessage = document.getElementById('error-message');

        const questionNumber = document.getElementById('question-number');
        const totalQuestions = document.getElementById('total-questions');
        const progressBar = document.getElementById('progress-bar');
        const questionText = document.getElementById('question-text');
        const answerOptionsContainer = document.getElementById('answer-options');
        const nextQuestionBtn = document.getElementById('next-question-btn');

        const finalResultText = document.getElementById('final-result-text');
        
        const submissionsList = document.getElementById('submissions-list');
        const backToLoginBtn = document.getElementById('back-to-login-btn');


        // Lógica de Autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Autenticação bem-sucedida. UID:", user.uid);
                startBtnText.classList.remove('hidden');
                startBtnLoader.classList.add('hidden');
                startQuizBtn.disabled = false;
                startQuizBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        (async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Falha crítica na autenticação:", error);
                displayError("Erro de conexão. Não é possível iniciar o quiz.");
                startBtnText.textContent = "Erro de Conexão";
                startBtnText.classList.remove('hidden');
                startBtnLoader.classList.add('hidden');
            }
        })();

        // Funções de controle da UI
        function showSection(section) {
            loginSection.classList.add('hidden');
            quizSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            adminSection.classList.add('hidden');
            section.classList.remove('hidden');
        }
        
        function displayError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function toggleButtonLoader(button, showLoader) {
            const btnText = button.querySelector('#start-btn-text');
            const btnLoader = button.querySelector('#start-btn-loader');
            if (showLoader) {
                if(btnText) btnText.classList.add('hidden');
                if(btnLoader) btnLoader.classList.remove('hidden');
                button.disabled = true;
            } else {
                if(btnText) btnText.classList.remove('hidden');
                if(btnLoader) btnLoader.classList.add('hidden');
                button.disabled = false;
            }
        }

        // Lógica do Quiz e Admin
        startQuizBtn.addEventListener('click', async () => {
            userEmail = emailInput.value.trim().toLowerCase();
            errorMessage.classList.add('hidden');

            if (!userEmail) {
                displayError("Por favor, insira seu e-mail.");
                return;
            }
            
            // Rota de Admin
            if (userEmail === 'ghp@volvo.com') {
                showAdminView();
                return;
            }

            // Rota de Participante
            if (!userEmail.endsWith('@volvo.com')) {
                displayError("Apenas e-mails com domínio @volvo.com são permitidos.");
                return;
            }

            toggleButtonLoader(startQuizBtn, true);

            try {
                const q = query(submissionsCollectionRef, where("email", "==", userEmail));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    displayError("Este e-mail já participou do quiz.");
                    toggleButtonLoader(startQuizBtn, false);
                    return;
                }
                
                startQuiz();

            } catch (error) {
                console.error("Erro ao verificar e-mail no Firestore: ", error);
                displayError("Erro ao iniciar. Verifique sua conexão e tente novamente.");
                toggleButtonLoader(startQuizBtn, false);
            }
        });

        function startQuiz() {
            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;
            totalQuestions.textContent = quizQuestions.length;
            showSection(quizSection);
            loadQuestion();
        }

        function loadQuestion() {
            selectedOption = null;
            const currentQuestion = quizQuestions[currentQuestionIndex];
            
            questionNumber.textContent = currentQuestionIndex + 1;
            progressBar.style.width = `${((currentQuestionIndex + 1) / quizQuestions.length) * 100}%`;
            questionText.textContent = currentQuestion.question;
            answerOptionsContainer.innerHTML = '';
            
            currentQuestion.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'w-full text-left p-4 rounded-lg answer-option hover:bg-gray-100';
                button.textContent = option;
                button.addEventListener('click', () => selectAnswer(button, option));
                answerOptionsContainer.appendChild(button);
            });
            
            nextQuestionBtn.disabled = true;
            nextQuestionBtn.classList.add('opacity-50');
            if (currentQuestionIndex === quizQuestions.length - 1) {
                nextQuestionBtn.textContent = 'Finalizar Quiz';
            } else {
                nextQuestionBtn.textContent = 'Próxima';
            }
        }

        function selectAnswer(button, option) {
            const previouslySelected = answerOptionsContainer.querySelector('.selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('selected');
            }
            
            button.classList.add('selected');
            selectedOption = option;

            nextQuestionBtn.disabled = false;
            nextQuestionBtn.classList.remove('opacity-50');
        }

        nextQuestionBtn.addEventListener('click', () => {
            if (selectedOption) {
                userAnswers.push(selectedOption);
                
                if (selectedOption === quizQuestions[currentQuestionIndex].answer) {
                    score++;
                }
                
                currentQuestionIndex++;
                
                if (currentQuestionIndex < quizQuestions.length) {
                    loadQuestion();
                } else {
                    finishQuiz();
                }
            }
        });

        function finishQuiz() {
            showSection(resultsSection);
            finalResultText.innerHTML = `Você acertou <span class="brand-blue">${score}</span> de <span class="brand-blue">${quizQuestions.length}</span> perguntas!`;
            saveResults();
        }

        async function saveResults() {
            const submission = {
                email: userEmail,
                score: score,
                submittedAt: new Date()
            };

            try {
                await addDoc(submissionsCollectionRef, submission);
                console.log("Resultado salvo com sucesso!");
            } catch (error) {
                console.error("Erro ao salvar resultado: ", error);
                finalResultText.innerHTML += '<p class="text-red-500 text-sm mt-4">Seu resultado não pôde ser salvo.</p>';
            }
        }
        
        // Funções do Admin
        async function showAdminView() {
            showSection(adminSection);
            submissionsList.innerHTML = `<div class="text-center p-4"><p class="text-gray-500 mt-2">Carregando participantes...</p></div>`;

            try {
                const querySnapshot = await getDocs(submissionsCollectionRef);
                const allSubmissions = [];
                querySnapshot.forEach(doc => {
                    allSubmissions.push(doc.data());
                });

                allSubmissions.sort((a, b) => b.submittedAt.toMillis() - a.submittedAt.toMillis());

                if (allSubmissions.length === 0) {
                    submissionsList.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhum participante respondeu ainda.</p>';
                    return;
                }

                submissionsList.innerHTML = '';
                allSubmissions.forEach(sub => {
                    const date = sub.submittedAt.toDate();
                    const formattedDate = `${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR')}`;
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                    listItem.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${sub.email}</p>
                            <p class="text-sm text-gray-500">${formattedDate}</p>
                        </div>
                        <span class="font-semibold text-blue-600">${sub.score} / ${quizQuestions.length}</span>
                    `;
                    submissionsList.appendChild(listItem);
                });

            } catch (error) {
                console.error("Erro ao carregar lista de participantes:", error);
                submissionsList.innerHTML = '<p class="text-center text-red-500 p-4">Não foi possível carregar a lista.</p>';
            }
        }

        backToLoginBtn.addEventListener('click', () => {
            emailInput.value = '';
            showSection(loginSection);
        });

    </script>
</body>
</html>
